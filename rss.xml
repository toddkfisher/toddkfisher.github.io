<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title><![CDATA[]]></title>
<description><![CDATA[]]></description>
<link>./</link>
<lastBuildDate>Fri, 13 Sep 2024 18:32:06 -0700</lastBuildDate>
<item>
  <title><![CDATA[Dimetric Transformation of 2d Images]]></title>
  <description><![CDATA[
<p>
<b>Project Summary and TL;DR</b>
</p>

<p>
Our end goal is an isometric game "engine" written in Common Lisp with some C
code where required.  The parts of the game written in Common Lisp  will use code
written in C using CFFI <sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>.
</p>

<p>
We will need to apply textures to surfaces
in 3d isometric which is discussed here.
</p>

<div id="outline-container-orgfc862f8" class="outline-2">
<h2 id="orgfc862f8"><span class="section-number-2">1.</span> 3d Projections</h2>
<div class="outline-text-2" id="text-1">
<p>
Figure <a href="#org96c403f">1</a> <sup><a id="fnr.2" class="footref" href="#fn.2" role="doc-backlink">2</a></sup> classifies different types of graphical
projections <sup><a id="fnr.3" class="footref" href="#fn.3" role="doc-backlink">3</a></sup>.  Our game will use a dimetric projection
where the angles between the horizontal axis have a slope of 1:2 (see figure <a href="#org47757be">2</a>).
This closely approximates an isometric projection where skewed lines have a slope of With a paint program a horizontal line can be drawn in 1:2 format as:
</p>

<ol class="org-ol">
<li>Two pixels along the screen X-axis.</li>
<li>Move up or down one pixel along the screen Y-axis.</li>
<li>Repeat at step 1.</li>
</ol>

<p>
In 0.5 slope format, the angle <sup><a id="fnr.4" class="footref" href="#fn.4" role="doc-backlink">4</a></sup> between a line which lies along the Y-axis <sup><a id="fnr.5" class="footref" href="#fn.5" role="doc-backlink">5</a></sup>,
as projected to the screen, and the X-axis is approximately 1159/2500 radians.
</p>


<figure id="org96c403f">
<img src="./projection-taxonomy.PNG" alt="projection-taxonomy.PNG" width="30%" height="30%">

<figcaption><span class="figure-number">Figure 1: </span><i>Comparison of 3d projection types.</i></figcaption>
</figure>
</div>
</div>

<div id="outline-container-org96fd40e" class="outline-2">
<h2 id="org96fd40e"><span class="section-number-2">2.</span> Simple Texture-Mapping</h2>
<div class="outline-text-2" id="text-2">
<p>
Two approches we can take are:
</p>

<ol class="org-ol">
<li>Draw textures directly in 1:2 format.  Figure <a href="#org47757be">2</a> below
shows an example green outlined square with yellow fill. The surrounding
blue is either transparent or a color key representing transparency
(think of bluescreen used in film). The main drawback of this approch is
that freely-available 2d textures are more plentiful than 1:2 dimetric textures.</li>

<li>Another approch is to use the built-in <code>cairo_set_matrix()</code> feature of
the <sup><a id="fnr.6" class="footref" href="#fn.6" role="doc-backlink">6</a></sup> Cairo graphics library to <i>transform</i> two-dimensional
textures to isometric format as in figure <a href="#orge3b416f">3</a> <sup><a id="fnr.7" class="footref" href="#fn.7" role="doc-backlink">7</a></sup> below.  We will
take this approch when possible.</li>
</ol>


<figure id="org47757be">
<img src="./iso-square.PNG" alt="iso-square.PNG" width="30%" height="30%">

<figcaption><span class="figure-number">Figure 2: </span><i>Square drawn in 1:2 format.</i></figcaption>
</figure>


<figure id="orge3b416f">
<img src="./dimetric.png" alt="dimetric.png" width="65%">

<figcaption><span class="figure-number">Figure 3: </span><i>2d &rArr; 1:2 dimetric transformtion geometry.</i></figcaption>
</figure>
</div>

<div id="outline-container-orgb36512d" class="outline-3">
<h3 id="orgb36512d"><span class="section-number-3">2.1.</span> Transformation Matrix.</h3>
<div class="outline-text-3" id="text-2-1">
<p>
To determine the transformation matrix from flat 2d, to dimetric format we can solve
the two matrix equations (5) and (6) below.  Assume that \(P, Q, R, S\) is a square with
sides of length 1. Also, let \(C = cos(\alpha)\) and \(S = sin(\alpha)\).
</p>

<p>
Taking point \(\boldsymbol{P}\) as \((0, 0)\):
</p>

\begin{equation}
  \boldsymbol{P}: (0, 0) \Rightarrow (0,0) \tag{1}
\end{equation}

<p>
and
</p>

\begin{equation}
  \boldsymbol{Q}: (1, 0) \Rightarrow (C, -S) \tag{2}
\end{equation}

\begin{equation}
  \boldsymbol{R}: (1, 1) \Rightarrow (2C, 0) \tag{3}
\end{equation}

\begin{equation}
  \boldsymbol{S}: (0, 1) \Rightarrow (C, S) \tag{4}
\end{equation}

<p>
Let our unknowns be \(I\), \(J\), \(K\), and \(M\).
Applying our unknown matrix to point \(\boldsymbol{Q}\) from (2):
</p>

\begin{equation}
  \begin{bmatrix}
  I & J \\
  K & M 
  \end{bmatrix}
  \begin{bmatrix}
  1 \\
  0 
  \end{bmatrix}
  =
  \begin{bmatrix}
      C \\
      -S
  \end{bmatrix} 
  \Rightarrow
  \begin{array}{l}
  I = C \\
  K = -S
  \end{array}
  \tag{5}
\end{equation}

<p>
and applying the matrix to point \(\boldsymbol{R}\) from (2):
</p>

\begin{equation}
  \begin{bmatrix}
  C  & J \\
  -S & M 
  \end{bmatrix}
  \begin{bmatrix}
  1 \\
  1 
  \end{bmatrix}
  =
  \begin{bmatrix}
      2C \\
      0
  \end{bmatrix} 
  \Rightarrow
  \begin{array}{l}
  C+J=2C \\
  -S+M=0
  \end{array}
  \Rightarrow
  \begin{array}{l}
  J=C \\
  M=S
  \end{array}
  \tag{6}
\end{equation}

<p>
which gives \(I=J=cos(\alpha)\), \(K=-sin(\alpha)\), and \(M=sin(\alpha)\).
</p>

<p>
As a check we can apply the transform to point \(\boldsymbol{S}\) from (4).
</p>

\begin{equation}
  \begin{bmatrix}
  C  & C \\
  -S & S 
  \end{bmatrix}
  \begin{bmatrix}
  0 \\
  1 
  \end{bmatrix}
  =
  \begin{bmatrix}
      C \\
      S
  \end{bmatrix} 
  \Rightarrow
  \begin{array}{l}
  0C+C=C \\
  0(-S)+S = S
  \end{array}
  \tag{7}
\end{equation}

<p>
And it checks out.
</p>

<p>
For a 1:2 dimetric projection, set \(\alpha=\) 1159.0/2500.0.
</p>
</div>
</div>
</div>

<div id="outline-container-org77b4cdb" class="outline-2">
<h2 id="org77b4cdb"><span class="section-number-2">3.</span> Test code.</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span><i>GTK 3.0 paint callback to test transform matrix.</i></label><pre class="src src-C" id="org50a2e69"><span class="linenr"> 0: </span><span style="color: #000000; font-weight: bold; font-style: italic;">static</span> <span style="color: #000000;">void</span> <span style="color: #000000;">do_drawing</span>(<span style="color: #000000;">cairo_t</span> *<span style="color: #000000;">cr</span>, <span style="color: #000000;">GtkWidget</span> *<span style="color: #000000;">widget</span>)
<span class="linenr"> 1: </span>{
<span class="linenr"> 2: </span>  <span style="color: #000000;">GtkWidget</span> *<span style="color: #000000;">win</span> = gtk_widget_get_toplevel(widget);
<span class="linenr"> 3: </span>  <span style="color: #000000;">int</span> <span style="color: #000000;">width</span>, <span style="color: #000000;">height</span>;
<span class="linenr"> 4: </span>  <span style="color: #000000;">double</span> <span style="color: #000000;">alpha</span> = atan(0.5);
<span class="linenr"> 5: </span>  <span style="color: #000000;">double</span> <span style="color: #000000;">C</span> = cos(alpha);
<span class="linenr"> 6: </span>  <span style="color: #000000;">double</span> <span style="color: #000000;">S</span> = sin(alpha);
<span class="linenr"> 7: </span>  <span style="color: #000000;">cairo_matrix_t</span> <span style="color: #000000;">M</span> =
<span class="linenr"> 8: </span>  {
<span class="linenr"> 9: </span>    .xx = C,   .yx = -S,
<span class="linenr">10: </span>    .xy = C,   .yy =  S,
<span class="linenr">11: </span>    .x0 = pos_x, .y0 = pos_y
<span class="linenr">12: </span>  };
<span class="linenr">13: </span>  gtk_window_get_size(GTK_WINDOW(win), &amp;width, &amp;height);
<span class="linenr">14: </span>  cairo_set_source_surface(cr, background_image, 0, 0);
<span class="linenr">15: </span>  cairo_paint(cr);
<span class="linenr">16: </span>  cairo_set_matrix(cr, &amp;M);
<span class="linenr">17: </span>  cairo_set_source_surface(cr, glob.image, 0, 0);
<span class="linenr">18: </span>  <span style="color: #000000;">int</span> <span style="color: #000000;">w</span> = cairo_image_surface_get_width(image);
<span class="linenr">19: </span>  <span style="color: #000000;">int</span> <span style="color: #000000;">h</span> = cairo_image_surface_get_height(image);
<span class="linenr">20: </span>  cairo_rectangle(cr, 0, 0, w, h);
<span class="linenr">21: </span>  cairo_clip(cr);
<span class="linenr">22: </span>  cairo_paint(cr);
<span class="linenr">23: </span>}
</pre>
</div>

<p>
In listing <a href="#org50a2e69">1</a>, lines 14 and 15, paint a background image which is loaded at startup.  Lines 7-12 and 16 set the cairo transform,
which, must be transposed from what one would expect.  The additional elements
<code>x0</code>, and <code>y0</code> allow for translation.  The transformed texture image is drawn on line 17.  To clip out regions
of the transformed image which may not lie in the diamond shape, we create a path (again transformed) around
the the diamond-shaped texture and clip anything exterior to it.
</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://cffi.common-lisp.dev/">https://cffi.common-lisp.dev/</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
By Cmglee, Own work, CC BY-SA 4.0, <a href="https://commons.wikimedia.org/w/index.php?curid=83384053">https://commons.wikimedia.org/w/index.php?curid=83384053</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3" role="doc-backlink">3</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
One, two, and three point persepectives apply when:
</p>
<ol class="org-ol">
<li>Displaying three orthogonal surfaces each with sets of parallel edges
intersecting at \(\pi/2\) angles.</li>
<li>Each plane is orthogonal to the others.</li>
</ol>

<p class="footpara">
In general though, an infinite number of vanishing points are possible.
</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4" role="doc-backlink">4</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
Angular units of measure are <i>RADIANS</i> here.  Degree, minutes, seconds or decimal degrees are
a relic from the Bablylonian era and have no place in the modern world.
</p></div></div>

<div class="footdef"><sup><a id="fn.5" class="footnum" href="#fnr.5" role="doc-backlink">5</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
Our axis convention will be:
</p>
<ol class="org-ol">
<li>X-axis direction, \(\boldsymbol{\hat{e}_x}\), is horizontal and positive to the right with respect to the viewer.</li>
<li>Z-axis direction, \(\boldsymbol{\hat{e}_z}\), is vertical and positive <i>UP</i> with respect to the viewer.</li>
<li>Y-axis direction is \(\boldsymbol{\hat{e}_y} = \boldsymbol{\hat{e}_z} \times  \boldsymbol{\hat{e}_x}\) or
\(\boldsymbol{\hat{e}_z} = \boldsymbol{\hat{e}_x} \times  \boldsymbol{\hat{e}_y}\)</li>
</ol>

<p class="footpara">
(Note \(\boldsymbol{\hat{e}}\) means "unit vector")
</p>

<p class="footpara">
This is as it should be. See figure <a href="#org3cdcc3b">4</a> below.
</p>


<figure id="org3cdcc3b">
<img src="./Gods-choosen-coordinate-system.png" alt="Gods-choosen-coordinate-system.png" width="30%" height="30%">

<figcaption><span class="figure-number">Figure 4: </span><i>"World-space" coordinate axes in relation to "screen-space" axes.  Image created with <a href="http://draw.io">http://draw.io</a> .</i></figcaption>
</figure></div></div>

<div class="footdef"><sup><a id="fn.6" class="footnum" href="#fnr.6" role="doc-backlink">6</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
All of our graphics are drawn using Gtk 3.0 (<a href="https://www.gtk.org">https://www.gtk.org</a>)and Cairo graphics (<a href="https://www.cairographics.org">https://www.cairographics.org</a>).
An xlib (<a href="https://en.wikipedia.org/wiki/Xlib">https://en.wikipedia.org/wiki/Xlib</a>) version is forthcoming.
</p></div></div>

<div class="footdef"><sup><a id="fn.7" class="footnum" href="#fnr.7" role="doc-backlink">7</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
Image created with <a href="http://draw.io">http://draw.io</a>
</p></div></div>


</div>
</div><div class="taglist"></div>
<h3>END</h3>

<hr>

]]></description>
  <link>./2024-09-13-dimetric-transformation-of-2d-images.html</link>
  <guid>./2024-09-13-dimetric-transformation-of-2d-images.html</guid>
  <pubDate>Fri, 13 Sep 2024 15:18:00 -0700</pubDate>
</item>
<item>
  <title><![CDATA[Sound Playback Identifiers: Using Bitfields, Structs and Unions Instead of Handwritten Shifting, Masking and Or-ing]]></title>
  <description><![CDATA[


<div id="outline-container-org44e2210" class="outline-2">
<h2 id="org44e2210"><span class="section-number-2">1.</span> Motivation for Using Bitfields.</h2>
<div class="outline-text-2" id="text-1">
<p>
In my last programming-related post <sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>, I described how sound playback resources in
Miniaudio <sup><a id="fnr.2" class="footref" href="#fn.2" role="doc-backlink">2</a></sup> are referenced with a single <code>uint32_t</code>:
</p>

<ul class="org-ul">
<li>6 bit index into an array of Miniaudio resources <code>g_sound_list[]</code></li>
<li>26 bit playback serial number uniquely identifies a sound playback
request.</li>
</ul>

<p>
Both fields are doing double-duty:
</p>

<ul class="org-ul">
<li>If first 6 bits = <code>#b111111</code> then the following 26 bits are an error code.</li>
</ul>

<p>
Indices, serial numbers, and error-codes are set and accessed with seven functions in
the <code>sound.c</code> module.  These are simple shift (<code>&lt;&lt;</code>), mask (<code>&amp;</code>), and or (<code>|</code>) bit
manipulation functions.
</p>

<p>
A cleaner solution would use bitfields and let the compiler generate the
shifting, masking, and or-ing.
</p>
</div>
</div>

<div id="outline-container-org19f8c56" class="outline-2">
<h2 id="org19f8c56"><span class="section-number-2">2.</span> Two Different Definitions.</h2>
<div class="outline-text-2" id="text-2">
<p>
My first attempt at using bitfields:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span><i>Playback ID structure using unions and bitfields</i>.</label><pre class="src src-C" id="org387bf4e"><span class="linenr"> 0: </span><span style="color: #000000; font-weight: bold; font-style: italic;">typedef</span> <span style="color: #000000; font-weight: bold; font-style: italic;">struct</span> <span style="color: #000000; font-weight: bold; font-style: italic;">__attribute__</span>((packed))
<span class="linenr"> 1: </span>{
<span class="linenr"> 2: </span>  <span style="color: #000000; font-weight: bold; font-style: italic;">union</span> 
<span class="linenr"> 3: </span>  {
<span class="linenr"> 4: </span>    <span style="color: #000000;">uint8_t</span> <span style="color: #000000;">id_idx</span> : 6;
<span class="linenr"> 5: </span>    <span style="color: #000000;">int8_t</span> <span style="color: #000000;">id_err_flag</span> : 6;
<span class="linenr"> 6: </span>  };
<span class="linenr"> 7: </span>  <span style="color: #000000; font-weight: bold; font-style: italic;">union</span> 
<span class="linenr"> 8: </span>  {
<span class="linenr"> 9: </span>    <span style="color: #000000;">uint32_t</span> <span style="color: #000000;">id_serial_n</span> : 26;
<span class="linenr">10: </span>    <span style="color: #000000;">uint32_t</span> <span style="color: #000000;">id_error_code</span> : 26;
<span class="linenr">11: </span>  };
<span class="linenr">12: </span>} <span style="color: #000000;">playback_id_t</span>;
</pre>
</div>

<p>
I expected <code>sizeof(playback_id_t) == 4</code> but it turned out to be 5 bytes so I abandoned
the idea for a while.  Another definition does yield <code>sizeof(playback_id_t) == 4</code>:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span><i>Second attempt at defining playback ID structure.</i></label><pre class="src src-C" id="orge84415c"><span class="linenr">0: </span><span style="color: #000000; font-weight: bold; font-style: italic;">typedef</span> <span style="color: #000000; font-weight: bold; font-style: italic;">struct</span> <span style="color: #000000; font-weight: bold; font-style: italic;">__attribute__</span>((packed))
<span class="linenr">1: </span>{
<span class="linenr">2: </span>  <span style="color: #000000;">int8_t</span>   <span style="color: #000000;">id_idx_or_error_flag</span> : 6;
<span class="linenr">3: </span>  <span style="color: #000000;">uint32_t</span> <span style="color: #000000;">id_serial_or_error_code</span> : 26;
<span class="linenr">4: </span>} <span style="color: #000000;">playback_id_t</span>;
</pre>
</div>
<p>
So my compiler doesn't seem to be as smart as I'd hoped.
I'm happy with <code>typedef</code> <a href="#orge84415c">2</a> and I'll use that.
</p>
</div>
</div>

<div id="outline-container-orge49dec8" class="outline-2">
<h2 id="orge49dec8"><span class="section-number-2">3.</span> Warning</h2>
<div class="outline-text-2" id="text-3">
<p>
The C standard makes no guarantees about the ordering of bitfields.  In my initial
shift/mask/or implementation this was completely under my control.  In Lisp code
I could simply assume that an error flag test could be written:
</p>

<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #000000; font-weight: bold; font-style: italic;">let</span> ((playback-id (snd:play-file-async <span style="color: #006400; font-style: italic;">"some-sound.mp3"</span>)))
    (<span style="color: #000000; font-weight: bold; font-style: italic;">when</span> (= (logand #x3f playback-id) #x3f)
        <span style="color: #7a7a7a; font-style: italic;">; Error</span>
    <span style="color: #7a7a7a; font-style: italic;">; ...</span>
</pre>
</div>

<p>
We'll have to do some testing and see what happens when we use bitfields.
</p>
</div>
</div>

<div id="outline-container-org0bdc7e5" class="outline-2">
<h2 id="org0bdc7e5"><span class="section-number-2">4.</span> Today's Agenda</h2>
<div class="outline-text-2" id="text-4">
<ol class="org-ol">
<li>Fidget around and test bit ordering in <code>typedef</code> <a href="#orge84415c">2</a>.</li>
<li>Add definition <a href="#orge84415c">2</a> to <code>sound.c</code>.</li>
<li>Replace shift/mask/&#x2026; function calls on <code>playback_id</code> values with ordinary
field references.</li>
</ol>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="./2024-08-18-tightening-up-sound-c.html">Tightening Up sound.c</a>  
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
See <a href="https://miniaud.io/">https://miniaud.io/</a>  
</p></div></div>


</div>
</div><div class="taglist"></div>
<h3>END</h3>

<hr>

]]></description>
  <link>./2024-08-26-bitfields-structs-and-unions-in-c.html</link>
  <guid>./2024-08-26-bitfields-structs-and-unions-in-c.html</guid>
  <pubDate>Mon, 26 Aug 2024 10:43:00 -0700</pubDate>
</item>
<item>
  <title><![CDATA[Choosing an Open-Source License]]></title>
  <description><![CDATA[
<p>
<b>Prevous livestream:</b>
</p>

<p>
<a href="https://www.youtube.com/live/DmznJlAIwsE">https://www.youtube.com/live/DmznJlAIwsE</a>
</p>

<div id="outline-container-org26b4599" class="outline-2">
<h2 id="org26b4599"><span class="section-number-2">1.</span> The Source Code for These Streams Should be Available on Github.</h2>
<div class="outline-text-2" id="text-1">
<p>
I believe that it's time to put the source code for my game project up on a Github repo.
This should include instructions on how to build and run.  At a minimum, you will need:
</p>
<ul class="org-ul">
<li><code>clang</code>,</li>
<li><code>SBCL</code> <sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>,</li>
<li><code>Emacs</code>, and</li>
<li><code>Sly</code> <sup><a id="fnr.2" class="footref" href="#fn.2" role="doc-backlink">2</a></sup> or <code>SLIME</code> <sup><a id="fnr.3" class="footref" href="#fn.3" role="doc-backlink">3</a></sup>.</li>
</ul>
</div>
</div>

<div id="outline-container-orga8d95bd" class="outline-2">
<h2 id="orga8d95bd"><span class="section-number-2">2.</span> Two Major Categories of Licenses.</h2>
<div class="outline-text-2" id="text-2">
<p>
Unfortunately I must release the code under some sort of open source license.
I would prefer that my work isn't stolen. In today's stream, I'll compare various
licenses.  Codeacademy <sup><a id="fnr.4" class="footref" href="#fn.4" role="doc-backlink">4</a></sup> gives is a good starting point:
</p>

<blockquote>
<p>
Most licenses fit into one of two broad categories: copyleft licenses or
permissive licenses. Depending on how you want other people to use your project,
you can narrow your choice down to one of these two categories.
</p>

<p>
[&#x2026;]
</p>

<p>
<b>COPYLEFT LICENSES</b>
</p>

<p>
A <b>copyleft</b> license requires that any modified version of an open source
project also be released under the same license as the original project.
</p>

<p>
[&#x2026;]
</p>

<p>
<b>PERMISSIVE LICENSES</b>
</p>

<p>
The other general category of open source licenses is <b>permissive</b>
licenses. Permissive licenses are different from copyleft licenses in that they
do not put restrictions on people modifying or redistributing a project.
</p>
</blockquote>

<p>
I'm going to select a copyleft license.
</p>
</div>
</div>

<div id="outline-container-org4e4d5c7" class="outline-2">
<h2 id="org4e4d5c7"><span class="section-number-2">3.</span> How Many Licenses Are Out There?</h2>
<div class="outline-text-2" id="text-3">
<p>
Wikipedia's <i>Comparison of free and open-source software licenses</i> <sup><a id="fnr.5" class="footref" href="#fn.5" role="doc-backlink">5</a></sup>
has a 41 row table comparison.
</p>
</div>
</div>

<div id="outline-container-org74c5f05" class="outline-2">
<h2 id="org74c5f05"><span class="section-number-2">4.</span> What I Want From a License.</h2>
<div class="outline-text-2" id="text-4">
<p>
It is very unlikely that anyone will "steal" the code for this tiny
project and close-source it for profit.  It's a good idea though to be aware of the major
FOSS licenses should you contribute to or create a larger project.
</p>

<p>
Here are my license preferences:
</p>
<ol class="org-ol">
<li>No one can make any money off of my work or any work derived from
it.</li>
<li>No one can take my work, modify it (even slightly) and
not credit me.</li>
<li>My original work and anything derived from it must always
be available in source form.</li>
</ol>
</div>
</div>

<div id="outline-container-org86d454d" class="outline-2">
<h2 id="org86d454d"><span class="section-number-2">5.</span> How Do the Major FOSS Licenses Stack Up?</h2>
<div class="outline-text-2" id="text-5">
<p>
Github has a website <sup><a id="fnr.6" class="footref" href="#fn.6" role="doc-backlink">6</a></sup> which compares eight popular FOSS licenses.  None of these
seems to satisfy criteral No. 1 above.
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-center">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Name</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-center">Criteria Satisfied</th>
<th scope="col" class="org-left">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">GNU AGPLv3</td>
<td class="org-left">copyleft</td>
<td class="org-center">2 &amp; 3</td>
<td class="org-left">Same as GPLv3 but network use is distribution</td>
</tr>

<tr>
<td class="org-left">GNU GPLv3</td>
<td class="org-left">copyleft</td>
<td class="org-center">2 &amp; 3</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">GNU LGPLv3</td>
<td class="org-left">copyleft</td>
<td class="org-center">2 &amp; 3</td>
<td class="org-left">(see below)</td>
</tr>

<tr>
<td class="org-left">Mozilla Public License 2.0</td>
<td class="org-left">?</td>
<td class="org-center">none</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Apache License 2.0</td>
<td class="org-left">permissive</td>
<td class="org-center">none</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">MIT License</td>
<td class="org-left">permissive</td>
<td class="org-center">none</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">Boost Software License 1.0</td>
<td class="org-left">permissive</td>
<td class="org-center">none</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">The Unlicense</td>
<td class="org-left">?</td>
<td class="org-center">none</td>
<td class="org-left">No conditions</td>
</tr>
</tbody>
</table>

<p>
LGPLv3 allows close-source software to include your work as long as:
</p>
<ul class="org-ul">
<li>Your source code is published and</li>
<li>The closed-source software uses your software through whatever interfaces are provided
(e.g. public functions in a shared-object library)</li>
</ul>
</div>
</div>

<div id="outline-container-org23f5c54" class="outline-2">
<h2 id="org23f5c54"><span class="section-number-2">6.</span> Conclusion</h2>
<div class="outline-text-2" id="text-6">
<p>
Any project that uses an AGPLv3 or GPLv3 licensed source-code is bound to the same terms.
AGPLv3 is the most restrictive of the two so I'm choosing that.
</p>

<p>
Now that I have this taken care of, I can move on to more interesting topics.
</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="http://sbcl.org">Steel Bank Common Lisp</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://joaotavora.github.io/sly/">Sly Common Lisp IDE</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3" role="doc-backlink">3</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://slime.common-lisp.dev/">The Superior Lisp Interaction Mode for Emacs</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4" role="doc-backlink">4</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
codeacademy: <a href="https://www.codecademy.com/article/choosing-an-open-source-license">Choosing An Open Source License</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.5" class="footnum" href="#fnr.5" role="doc-backlink">5</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
Wikipedia: <a href="https://en.wikipedia.org/wiki/Comparison_of_free_and_open-source_software_licenses">Comparison of Free and Open-Source Software Licenses</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.6" class="footnum" href="#fnr.6" role="doc-backlink">6</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
Github: <a href="https://choosealicense.com/">Choose an open source license</a> and <a href="https://choosealicense.com/licenses/">Licenses</a>
</p></div></div>


</div>
</div><div class="taglist"></div>
<h3>END</h3>

<hr>

]]></description>
  <link>./2024-08-21-foss-licenses-and-how-i-publish-livestream-notes.html</link>
  <guid>./2024-08-21-foss-licenses-and-how-i-publish-livestream-notes.html</guid>
  <pubDate>Wed, 21 Aug 2024 20:04:00 -0700</pubDate>
</item>
<item>
  <title><![CDATA[Tightening Up sound.c]]></title>
  <description><![CDATA[
<p>
<b>Previous Stream:</b>
<a href="https://www.youtube.com/watch?v=L-ri_PFpmcA">https://www.youtube.com/watch?v=L-ri_PFpmcA</a>
</p>

<div id="outline-container-org0b934c7" class="outline-2">
<h2 id="org0b934c7"><span class="section-number-2">1.</span> Playback Serial Numbers.</h2>
<div class="outline-text-2" id="text-1">
<p>
In my first draft of <code>sound.c</code>, a typical use might be:
</p>
<ol class="org-ol">
<li>Client requests playback by calling <code>snd_play_mem_async()</code> or
<code>snd_play_file_async()</code>.</li>
<li>Index into the resource list (<code>g_sound_list[]</code>) returned on success and sound begins playing.</li>
<li>Sound cancellation (freeing of Miniaudio <sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup> resources) occurs by:
<ul class="org-ul">
<li>In-progress playback can be cancelled by calling <code>snd_cancel_async(idx)</code>
where <code>idx</code> is the index returned in step 1. <b>OR</b></li>
<li>Playback completes.</li>
</ul></li>
</ol>

<p>
After thinking for a bit, I realized that the following could occur.
</p>

<ol class="org-ol">
<li>Steps 1-3 above.</li>
<li>After playback, client requests playback of another sound and receives <i>the same</i> index
as in step 2. above.</li>
<li>Another part of the client code believes that the original playback above is still in
progress and requests cancellation.</li>
<li>New playback using same index is cancelled instead.</li>
</ol>

<p>
A solution is to simply modify <code>snd_play_(mem|file)_async()</code> to instead
return a pair: <code>(serial_number, resource_index)</code> where <code>serial_number</code> is
unique for each playback request <sup><a id="fnr.2" class="footref" href="#fn.2" role="doc-backlink">2</a></sup>.  To cancel, <code>snd_cancel_async()</code> would
take the serial number and index as parameters. It should be an error condition, if the
client attempts to stop playback with a serial number that has "expired".
</p>
</div>
</div>

<div id="outline-container-org4e2418f" class="outline-2">
<h2 id="org4e2418f"><span class="section-number-2">2.</span> Playback ID format.</h2>
<div class="outline-text-2" id="text-2">
<p>
Figure <a href="#org7bc6a6f">1</a> <sup><a id="fnr.3" class="footref" href="#fn.3" role="doc-backlink">3</a></sup> below shows how the <code>serial_number</code> and <code>resource_index</code> bits are
smashed together into a single <code>uint32_t</code>  Note that serial numbers are 26 bits
wide and "wrap around" after approximately 67.1 million plays - an acceptable number
(for me at least) <sup><a id="fnr.4" class="footref" href="#fn.4" role="doc-backlink">4</a></sup>.
</p>


<figure id="org7bc6a6f">
<img src="./playback-id-bit-layout.png" alt="playback-id-bit-layout.png" width="65%">

<figcaption><span class="figure-number">Figure 1: </span><i>Playback ID bit layout.</i></figcaption>
</figure>

<p>
Since we must also signal error conditions to a caller and since we're returning a single
<code>uint32_t</code>, some range of possible values must represent an error condition.  See figure
<a href="#orgc5d65e4">2</a> <sup><a id="fnr.5" class="footref" href="#fn.5" role="doc-backlink">5</a></sup> <sup>, </sup><sup><a id="fnr.6" class="footref" href="#fn.6" role="doc-backlink">6</a></sup>.
</p>


<figure id="orgc5d65e4">
<img src="./bit-layout-error.png" alt="bit-layout-error.png" width="65%">

<figcaption><span class="figure-number">Figure 2: </span><i>Bit layout for error condition.</i></figcaption>
</figure>


<p>
As it stands today, listing <a href="#org8cbf343">1</a> is the <code>struct</code> I'm using for Miniaudio resource management:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span><i>C struct for Miniaudio resource management.</i></label><pre class="src src-C" id="org8cbf343"><span class="linenr"> 0: </span><span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">Member prefix "s_" == "sound"</span>
<span class="linenr"> 1: </span><span style="color: #000000; font-weight: bold; font-style: italic;">typedef</span> <span style="color: #000000; font-weight: bold; font-style: italic;">struct</span>
<span class="linenr"> 2: </span>{
<span class="linenr"> 3: </span>  <span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">Miniaudio resource.  Created/destroyed each time a sound is played/stopped.</span>
<span class="linenr"> 4: </span>  <span style="color: #000000;">ma_device</span>        <span style="color: #000000;">s_device</span>;         
<span class="linenr"> 5: </span>  <span style="color: #000000;">ma_device_config</span> <span style="color: #000000;">s_device_config</span>;
<span class="linenr"> 6: </span>  <span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">Miniaudio resource.  Created/destroyed each time a sound is played/stopped.</span>
<span class="linenr"> 7: </span>  <span style="color: #000000;">ma_decoder</span>       <span style="color: #000000;">s_decoder</span>;        
<span class="linenr"> 8: </span>  <span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">Sound play is cancelled but not necessarily stopped yet.</span>
<span class="linenr"> 9: </span>  <span style="color: #000000;">atomic_bool</span>      <span style="color: #000000;">s_cancel_sent</span>;    
<span class="linenr">10: </span>  <span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">Miniaudio resources in this slot available for playback or is this slot currently in use or in</span>
<span class="linenr">11: </span>  <span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">the process of being cancelled.</span>
<span class="linenr">12: </span>  <span style="color: #000000;">atomic_bool</span>      <span style="color: #000000;">s_is_available</span>;   
<span class="linenr">13: </span>  <span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">Unique identifier returned when playback is initiated.</span>
<span class="linenr">14: </span>  <span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">Format:                                                     </span>
<span class="linenr">15: </span>  <span style="color: #7a7a7a; font-style: italic;">//          </span><span style="color: #7a7a7a; font-style: italic;">- bits [0:5] Index of sound resource in 'g_sound_list[]'</span>
<span class="linenr">16: </span>  <span style="color: #7a7a7a; font-style: italic;">//                       </span><span style="color: #7a7a7a; font-style: italic;">If = 0x3f (= 0b111111), then this id is an error code.</span>
<span class="linenr">17: </span>  <span style="color: #7a7a7a; font-style: italic;">//          </span><span style="color: #7a7a7a; font-style: italic;">- bits [8:32] Serial # uniquely identifying playback request.</span>
<span class="linenr">18: </span>  <span style="color: #7a7a7a; font-style: italic;">//                       </span><span style="color: #7a7a7a; font-style: italic;">If bits [0:5] = 0b111111, then bits[8:32]  identify the</span>
<span class="linenr">19: </span>  <span style="color: #7a7a7a; font-style: italic;">//                       </span><span style="color: #7a7a7a; font-style: italic;">specific error code.</span>
<span class="linenr">20: </span>  <span style="color: #7a7a7a; font-style: italic;">//          </span><span style="color: #7a7a7a; font-style: italic;">NOTE: Encoding index/serial#/error code into a single uint32_t means that</span>
<span class="linenr">21: </span>  <span style="color: #7a7a7a; font-style: italic;">//          </span><span style="color: #7a7a7a; font-style: italic;">we can pass around and return these as a single number.</span>
<span class="linenr">22: </span>  <span style="color: #000000;">uint32_t</span>         <span style="color: #000000;">s_playback_id</span>;
<span class="linenr">23: </span>  <span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">Index of these miniaudio resources in 'g_sound_list[]'.  Redundant since</span>
<span class="linenr">24: </span>  <span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">bits [0:5] of 's_playback_id' hold the same index.</span>
<span class="linenr">25: </span>  <span style="color: #000000;">uint32_t</span>         <span style="color: #000000;">s_idx_sound_list</span>; 
<span class="linenr">26: </span>  <span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">Playing from file or from memory?</span>
<span class="linenr">27: </span>  <span style="color: #000000;">source_type_t</span>    <span style="color: #000000;">s_source_type</span>;    
<span class="linenr">28: </span>  <span style="color: #000000; font-weight: bold; font-style: italic;">union</span>
<span class="linenr">29: </span>  {
<span class="linenr">30: </span>    <span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">Pointer to memory block of preloaded sound file.</span>
<span class="linenr">31: </span>    <span style="color: #000000;">void</span>           *<span style="color: #000000;">s_p_preloaded_sound</span>;
<span class="linenr">32: </span>    <span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">... Or jus the filepath if not preloaded.</span>
<span class="linenr">33: </span>    <span style="color: #000000;">ASCII</span>          <span style="color: #000000;">s_file_path</span>[FILENAME_MAX];
<span class="linenr">34: </span>  };
<span class="linenr">35: </span>} <span style="color: #000000;">sound_t</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb50e703" class="outline-2">
<h2 id="orgb50e703"><span class="section-number-2">3.</span> Today's Agenda</h2>
<div class="outline-text-2" id="text-3">
<ol class="org-ol">
<li>The code to create/extract (<code>serial_number</code>, <code>resource_index</code>) pairs from <code>uint32_t</code>'s has been written
but isn't used anywhere.  Modify any affected function in <code>sound.c</code></li>
<li>Walk through <code>sound.c</code> and <i>informally</i> convince ourselves that there are no
race conditions or deadlocks.</li>
</ol>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
See <a href="https://miniaud.io/">https://miniaud.io/</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
(<code>serial_number</code>, <code>resource_index</code>) pairs are smashed into a single
<code>uint32_t</code> which the CFFI client will pass to <code>snd_cancel_async()</code>. I would
prefer to return two values but I don't know of a simple way to do this in CFFI
(at the time of writing this).
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3" role="doc-backlink">3</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
Image created with <a href="http://draw.io">Draw.io</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4" role="doc-backlink">4</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
This won't work if we have sounds that repeat endlessly.  It's possible that
67 million sounds could have been played and wraparound could
clobber any long-running playback.
</p></div></div>

<div class="footdef"><sup><a id="fn.5" class="footnum" href="#fnr.5" role="doc-backlink">5</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
Perhaps C's bitfield feature would be more appropriate here.  
</p></div></div>

<div class="footdef"><sup><a id="fn.6" class="footnum" href="#fnr.6" role="doc-backlink">6</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
Placing the 6-bit error field in bits [26:31] would make checking for error codes simpler.  For example:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span class="linenr">0: </span>(<span style="color: #000000; font-weight: bold; font-style: italic;">let</span> ((playback-id (snd:play-file-async <span style="color: #006400; font-style: italic;">"some-sound.mp3"</span>)))
<span class="linenr">1: </span>  (<span style="color: #000000; font-weight: bold; font-style: italic;">when</span> (&gt;= playback-id #xfc000000) <span style="color: #7a7a7a; font-style: italic;">; #xfc000000 = #b11111100000000000000000000000000</span>
<span class="linenr">2: </span>      <span style="color: #7a7a7a; font-style: italic;">; Error</span>
<span class="linenr">3: </span>  <span style="color: #7a7a7a; font-style: italic;">; ... </span>
</pre>
</div>
<p class="footpara">
As opposed to:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span class="linenr">0: </span>(<span style="color: #000000; font-weight: bold; font-style: italic;">let</span> ((playback-id (snd:play-file-async <span style="color: #006400; font-style: italic;">"some-sound.mp3"</span>)))
<span class="linenr">1: </span>  (<span style="color: #000000; font-weight: bold; font-style: italic;">when</span> (= (logand #x3f playback-id) #x3f)
<span class="linenr">2: </span>      <span style="color: #7a7a7a; font-style: italic;">; Error</span>
<span class="linenr">3: </span>  <span style="color: #7a7a7a; font-style: italic;">; ... </span>
</pre>
</div></div></div>


</div>
</div><div class="taglist"></div>
<h3>END</h3>

<hr>

]]></description>
  <link>./2024-08-18-tightening-up-sound-c.html</link>
  <guid>./2024-08-18-tightening-up-sound-c.html</guid>
  <pubDate>Sun, 18 Aug 2024 13:43:00 -0700</pubDate>
</item>
<item>
  <title><![CDATA[Error Handling in the sound.c Module]]></title>
  <description><![CDATA[
<p>
<b>Previous livestreams</b>
</p>

<p>
<a href="https://www.youtube.com/watch?v=5OrYG_7_uHY">https://www.youtube.com/watch?v=5OrYG_7_uHY</a>
</p>

<p>
<a href="https://www.youtube.com/watch?v=L-ri_PFpmcA">https://www.youtube.com/watch?v=L-ri_PFpmcA</a>
</p>

<div id="outline-container-org1ac9cd6" class="outline-2">
<h2 id="org1ac9cd6"><span class="section-number-2">1.</span> Today's Agenda</h2>
<div class="outline-text-2" id="text-1">
<p>
The wrapper code for Miniaudio <sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup> low-level playback has been added to
<code>sound.c</code> and all compiler errors removed.  It is time to walk through
the code to convince myself that it's correct.  I will also add error-handling
and error-cleanup code as described below.
</p>
</div>
</div>

<div id="outline-container-org94f2274" class="outline-2">
<h2 id="org94f2274"><span class="section-number-2">2.</span> Error-Handling and Cleanup</h2>
<div class="outline-text-2" id="text-2">
<p>
I'm going to call this a "crabs in a bucket" strategy: "If I couldn't do something
then no one else can either."  Any pthreads or Miniaudio function call that returns
an error code will result in:
</p>
<ol class="org-ol">
<li>The line number, API, and error code are saved into global variables.</li>
<li>A global flag: <code>g_something_failed</code> is set to true.</li>
</ol>
<p>
Every function call in <code>sound.c</code> will begin with code similar to:
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #000000; font-weight: bold; font-style: italic;">if</span> (atomic_load(&amp;g_something_failed))
  <span style="color: #000000; font-weight: bold; font-style: italic;">return</span> <span style="color: #7a7a7a; font-style: italic;">/* </span><span style="color: #7a7a7a; font-style: italic;">some error code</span><span style="color: #7a7a7a; font-style: italic;"> */</span>
</pre>
</div>
<p>
Lisp code that calls exported functions in <code>libsound.so</code> should check for error codes.
On receiving an error the Lisp code should signal an error and provide restarts <sup><a id="fnr.2" class="footref" href="#fn.2" role="doc-backlink">2</a></sup> if
appropriate.
</p>
</div>
</div>
<div id="outline-container-org4141473" class="outline-2">
<h2 id="org4141473"><span class="section-number-2">3.</span> Error Cleanup</h2>
<div class="outline-text-2" id="text-3">
<p>
The destructor function in <code>sound.c</code> :
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #000000;">void</span> <span style="color: #000000; font-weight: bold; font-style: italic;">__attribute__</span>((destructor)) <span style="color: #000000;">snd_shared_object_uninit</span>(<span style="color: #000000;">void</span>)
</pre>
</div>
<p>
Should terminate <code>snd_cancel_thread()</code> with:
</p>
<div class="org-src-container">
<pre class="src src-C">atomic_store(&amp;g_stop_cancel_thread, <span style="color: #a9a9a9; font-style: italic;">true</span>);  <span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">stop snd_cancel_thread() if it's awake and running.</span>
pthread_mutex_lock(&amp;g_mtx_sound_list);
pthread_cond_signal(&amp;g_cnd_cancel);  <span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">get snd_cancel_thread() ready to wake</span>
pthread_mutex_unlock(&amp;g_mtx_sound_list);  <span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">wake snd_cancel_thread().</span>
</pre>
</div>
<p>
When <code>snd_cancel_thread()</code> is awakened it will free up any Miniaudio resources in use.
</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
See <a href="https://miniaud.io/">https://miniaud.io/</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
One such restart might be to unload then reload <code>libsound.so</code> and continue program execution.
</p></div></div>


</div>
</div><div class="taglist"></div>
<h3>END</h3>

<hr>

]]></description>
  <link>./2024-08-05-error-handling-in-the-sound.c-module.html</link>
  <guid>./2024-08-05-error-handling-in-the-sound.c-module.html</guid>
  <pubDate>Mon, 05 Aug 2024 12:15:00 -0700</pubDate>
</item>
<item>
  <title><![CDATA[Continuing Sound-Related Coding]]></title>
  <description><![CDATA[
<p>
<b>Prevous livestream:</b>
</p>

<p>
<a href="https://youtube.com/live/i-WEMsvJoJw">https://youtube.com/live/i-WEMsvJoJw</a>
</p>

<p>
In my last livestream, I "tested" asychronous sound playback/stop using
Miniaudio's <sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup> low-level API.  All of this code lived in <code>simple-playback.c</code> which was
intended as a proof-of-concept.  Today I'll be moving code to <code>sound.c</code> which
compiles to a dynamically-loaded library <code>libsound.so</code>.  Once we have a working
<code>libsound</code> we can stress-test our sound code in Lisp.
</p>

<p>
<b>Warning:</b> this will be sleep-inducing as it's mostly copy/paste and fixing compilation errors.
</p>

<p>
<b>2nd Warning:</b> it's a lovely afternoon outside and I have my patio door open, which means
there might be some noise in the background.
</p>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
See <a href="https://miniaud.io/">https://miniaud.io/</a>
</p></div></div>


</div>
</div><div class="taglist"></div>
<h3>END</h3>

<hr>

]]></description>
  <link>./2024-08-03-moving-code-to-sound.c-shared-object.html</link>
  <guid>./2024-08-03-moving-code-to-sound.c-shared-object.html</guid>
  <pubDate>Sat, 03 Aug 2024 13:04:00 -0700</pubDate>
</item>
<item>
  <title><![CDATA[Testing Sound Playback]]></title>
  <description><![CDATA[
<p>
<b>Previous livestreams:</b>
</p>

<p>
<a href="https://www.youtube.com/watch?v=49ojU19ruHk">https://www.youtube.com/watch?v=49ojU19ruHk</a>
</p>

<p>
<a href="https://www.youtube.com/watch?v=8zS1ABTCTmos">https://www.youtube.com/watch?v=8zS1ABTCTmos</a>
</p>

<div id="outline-container-org08727f0" class="outline-2">
<h2 id="org08727f0"><span class="section-number-2">1.</span> Today's Agenda</h2>
<div class="outline-text-2" id="text-1">
<p>
I  have  a  small  test   program,  <code>simple-playback.c</code>,  which  uses  Miniaudio
(<a href="https://miniaud.io/">https://miniaud.io/</a>)   for  asychronous   sound   playback  and   cancellation.
<code>simple-playback.c</code>  is  a  "wrapper"  around Miniaudio's  low-level  API.   The
low-level  API  must  be  used  to play sound  files  preloaded  into  memory  (see
<a href="2024-07-28-playing-sounds-using-in-memory-blobs.html">Livestream  post 28-July-24</a>)  The wrapper  code in  <code>simple-playback.c</code> will  be
tested today  (hopefully) and I'll  begin moving functions prefixed  with <code>snd_</code>
over to the <code>sound.c</code> module.  <code>sound.c</code> compiles to <code>libsound.so</code>.  Once that's
complete, we should be able to use Lisp/CFFI to call exported functions from the
Lisp REPL.
</p>
</div>
</div>

<div id="outline-container-orgb5e5db0" class="outline-2">
<h2 id="orgb5e5db0"><span class="section-number-2">2.</span> Exporting C Functions to Lisp</h2>
<div class="outline-text-2" id="text-2">
<p>
A note about what  I mean by "exporting functions to Lisp/CFFI".   I have a Lisp
program <code>cffi-gen.lisp</code> which parses a limited form of C function declarations:
</p>


<figure id="org55016e0">
<img src="./CFFI-line-syntax.PNG" alt="CFFI-line-syntax.PNG" width="65%">

<figcaption><span class="figure-number">Figure 1: </span><i>Syntax for C functions exported to Lisp/CFFI. (using: <a href="https://www.bottlecaps.de/rr/ui">https://www.bottlecaps.de/rr/ui</a>)</i></figcaption>
</figure>

<p>
and produces the appropriate Lisp/CFFI <code>defcfun</code>.  <i>type-names</i> and the <i>parameter-list</i> are
severly restricted but adequate for this project.
</p>

<p>
For example, the C function declaration:
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #000000;">void</span> <span style="color: #000000;">ui_set_kbd_repeat</span>(<span style="color: #000000;">uint32_t</span> <span style="color: #000000;">timeout_ms</span>, <span style="color: #000000;">uint32_t</span> <span style="color: #000000;">delay_ms</span>)  <span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">EXPORT</span>
</pre>
</div>

<p>
Produces:
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span class="linenr">0: </span>(cffi:defcfun (<span style="color: #006400; font-style: italic;">"ui_set_kbd_repeat"</span> set-kbd-repeat) <span style="color: #000000; font-weight: bold;">:void</span>
<span class="linenr">1: </span>              (timeout-ms <span style="color: #000000; font-weight: bold;">:uint32</span>)
<span class="linenr">2: </span>              (delay-ms <span style="color: #000000; font-weight: bold;">:uint32</span>))
<span class="linenr">3: </span>(export 'set-kbd-repeat)
</pre>
</div>

<p>
when run through <code>cffi-gen.lisp</code>.
</p>
</div>
</div>
<div class="taglist"></div>
<h3>END</h3>

<hr>

]]></description>
  <link>./2024-07-30-testing-sound-playback.html</link>
  <guid>./2024-07-30-testing-sound-playback.html</guid>
  <pubDate>Tue, 30 Jul 2024 12:54:00 -0700</pubDate>
</item>
<item>
  <title><![CDATA[Playing Sounds Using In-Memory BLOBS]]></title>
  <description><![CDATA[
<p>
<b>Binary large object (BLOB)</b>
<i>is a generic term used to  describe the handling and</i>
<i>storage of  long strings  of data by  database management systems.  A BLOB  is a</i>
<i>category of data,  characterized by large size (including media  formats such as</i>
<i>audio and video), which can place extreme demands on storage systems and network</i>
<i>bandwidth.</i>
<a href="https://www.gartner.com/en/information-technology/glossary/blob-binary-large-object">Gartner.com</a>
</p>

<p>
<b>Summary:</b> I  briefly describe how  thread-based resource management is  used in
<del><code>sound.c</code></del> <code>simple-playback.c</code>  and how it  will be modified to  play preloaded
sound files residing in memory.
</p>

<div id="outline-container-org7c1b946" class="outline-2">
<h2 id="org7c1b946"><span class="section-number-2">1.</span> SOUND PLAYBACK AND RESOURCE MANAGEMENT.</h2>
<div class="outline-text-2" id="text-1">
<p>
<code>Miniaudio</code> has a simple way of playing a sound file:
<code>ma_engine_play_sound()</code> which is adequate for asynchronously loading and
playing sounds.  We would like to preload sounds and play them from memory but
there is no simple high-level function for this.  We must resort to <code>Miniaudio</code>'s
"low-level" API.
</p>

<p>
To play sounds through the low-level API we must:
</p>
<ol class="org-ol">
<li>Create an <code>ma_decoder</code> from a file or block of memory.  The decoder must
be configured for sample format, channel count, and sample rate.</li>
<li>An <code>ma_device</code> must be configured and initialized.  The device contains references
to the decoder created in step 1 as well as a callback function which uses the decoder to
provide <code>Miniaudio</code> with frames (a frame is a set of samples: one per channel).</li>
<li>We must start the device. This begins playing the sound.</li>
</ol>

<p>
End of playback is detected in our data callback:
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #000000; font-weight: bold; font-style: italic;">if</span> (MA_AT_END == ma_decoder_read_pcm_frames(pDecoder, pOutput, frameCount, <span style="color: #a9a9a9; font-style: italic;">NULL</span>))
  <span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">...</span>
</pre>
</div>

<p>
And we free Miniaudio resources with <code>ma_device_uninit()</code> and <code>ma_decoder_uninit()</code> but
this <i>must not happen</i> in the data callback, it must occur in another thread. <sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>
To overcome this restriction we have a separate thread function, <code>snd_cancel_thread()</code>:
which calls <code>ma_(device|decoder)_uninit()</code> when a condition <code>g_cnd_cancel</code> is
signalled.
</p>

<p>
In <code>sound.c</code>,  devices and decoders  are stored in an  array: <code>g_sound_list[]</code>.
Each entry  in <code>g_sound_list[]</code> is a  structure which holds an  "is available"
flag:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span><i>Data structures for storing sounds during playback.</i></label><pre class="src src-C"><span class="linenr"> 0: </span><span style="color: #000000; font-weight: bold; font-style: italic;">typedef</span> <span style="color: #000000; font-weight: bold; font-style: italic;">struct</span>
<span class="linenr"> 1: </span>{
<span class="linenr"> 2: </span>  <span style="color: #000000;">ma_device</span>        <span style="color: #000000;">s_device</span>;
<span class="linenr"> 3: </span>  <span style="color: #000000;">ma_device_config</span> <span style="color: #000000;">s_device_config</span>;
<span class="linenr"> 4: </span>  <span style="color: #000000;">ma_decoder</span>       <span style="color: #000000;">s_decoder</span>;
<span class="linenr"> 5: </span>  <span style="color: #000000;">atomic_bool</span>      <span style="color: #000000;">s_cancel_sent</span>;
<span class="linenr"> 6: </span>  <span style="color: #000000;">atomic_bool</span>      <span style="color: #000000;">s_is_available</span>;
<span class="linenr"> 7: </span>  <span style="color: #000000;">int</span>              <span style="color: #000000;">s_idx_sound_list</span>;
<span class="linenr"> 8: </span>} <span style="color: #000000;">sound_t</span>;
<span class="linenr"> 9: </span>
<span class="linenr">10: </span><span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">Array of sound resources.</span>
<span class="linenr">11: </span><span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">IF g_sound_list[i].s_is_available &amp;&amp; !g_sound_list[i].s_cancel_sent THEN:</span>
<span class="linenr">12: </span><span style="color: #7a7a7a; font-style: italic;">//</span>
<span class="linenr">13: </span><span style="color: #7a7a7a; font-style: italic;">//   </span><span style="color: #7a7a7a; font-style: italic;">slot i may be used as a decoder and device to play a sound.</span>
<span class="linenr">14: </span><span style="color: #7a7a7a; font-style: italic;">//</span>
<span class="linenr">15: </span><span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">NOTE that there is no free list of available slots.  The list must be scanned to find</span>
<span class="linenr">16: </span><span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">a free slot i.</span>
<span class="linenr">17: </span><span style="color: #000000;">#define</span> <span style="color: #000000;">MAX_SOUNDS</span> 25
<span class="linenr">18: </span><span style="color: #000000;">sound_t</span> <span style="color: #000000;">g_sound_list</span>[MAX_SOUNDS];
</pre>
</div>

<p>
Sound playback is achieved  with <code>snd_play_file_async()</code> which finds an
index of an available device/decoder and then proceeds with steps 1-3 above.  And
the resources in <code>g_sound_list[</code> <i>&lt;index&gt;</i> <code>]</code> are made unavailable.
</p>

<p>
Cancellation of a sound can occur when a sound has completed playing or during
playback.  <code>snd_cancel_async()</code> places the an index of an entry in <code>g_sound_list[]</code>
onto <code>g_cancel_list[]</code> and signals <code>g_cnd_cancel</code> waking up the <code>snd_cancel_thread()</code>.
A mutex, <code>g_mtx_sound_list</code>, is used to synchronize access to <code>g_sound_list[]</code> and <code>g_cancel_list[]</code>.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span><i>Array storing indices (into <code>g_sound_list[]</code>) of <code>Miniaudio</code> resources to release.</i></label><pre class="src src-C"><span class="linenr">0: </span><span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">Indices into g_sound_list[] of sounds/resources to be cancelled &amp; freed.</span>
<span class="linenr">1: </span><span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">Only indices stored in g_cancel_list[0] .. g_cancel_list[g_cancel_list_end - 1]</span>
<span class="linenr">2: </span><span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">are valid.</span>
<span class="linenr">3: </span><span style="color: #000000;">int</span> <span style="color: #000000;">g_cancel_list_end</span> = 0;
<span class="linenr">4: </span><span style="color: #000000;">int</span> <span style="color: #000000;">g_cancel_list</span>[MAX_SOUNDS];
<span class="linenr">5: </span>
<span class="linenr">6: </span><span style="color: #7a7a7a; font-style: italic;">// </span><span style="color: #7a7a7a; font-style: italic;">Synchronize access to g_sound_list[] and g_cancel_list[].</span>
<span class="linenr">7: </span><span style="color: #000000;">pthread_mutex_t</span> <span style="color: #000000;">g_mtx_sound_list</span> = PTHREAD_MUTEX_INITIALIZER;
</pre>
</div>

<p>
All of this functionality will eventually be used in LISP through <code>CFFI</code>.
</p>
</div>
</div>

<div id="outline-container-org8697938" class="outline-2">
<h2 id="org8697938"><span class="section-number-2">2.</span> REGION-BASED MEMORY MANAGEMENT</h2>
<div class="outline-text-2" id="text-2">
<p>
We would prefer that our LISP code not call <code>malloc()</code> and <code>free()</code>.  It is expected that
sounds will be loaded into memory when our program starts.
</p>

<p>
<code>stk-alloc.c</code> allocates memory blocks by simply advancing a pointer <code>g_p_next</code> when a
block is requested (<code>stkalloc_get_mem()</code>).  Calling <code>stkalloc_free(p)</code> adjusts <code>g_p_next</code>
to <code>p</code> and so everything allocated after <code>p</code> is released as well.
</p>
</div>
</div>

<div id="outline-container-orgbcc54bc" class="outline-2">
<h2 id="orgbcc54bc"><span class="section-number-2">3.</span> PLAYING SOUNDS PRELOADED IN MEMORY</h2>
<div class="outline-text-2" id="text-3">
<p>
So far all of the code for sound playback lives in a test program, <code>simple-playback.c</code>.
In today's livestream, we will:
</p>
<ol class="org-ol">
<li>Load several sound files into memory using <code>libstackalloc</code>.</li>
<li>Provide some sort of UI for playing and cancelling sounds.</li>
</ol>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
Calling <code>ma_device_uninit()</code> and <code>ma_decoder_uninit()</code> will also stop a sound currently playing.
</p></div></div>


</div>
</div><div class="taglist"></div>
<h3>END</h3>

<hr>

]]></description>
  <link>./2024-07-28-playing-sounds-using-in-memory-blobs.html</link>
  <guid>./2024-07-28-playing-sounds-using-in-memory-blobs.html</guid>
  <pubDate>Sun, 28 Jul 2024 21:34:00 -0700</pubDate>
</item>
<item>
  <title><![CDATA[First Blog Post]]></title>
  <description><![CDATA[
<p>
<b>Summary:</b> This is a first test-post.  In the future each of my livestreams
will have a companion blog post here.
</p>

<div id="outline-container-org0d6ca9d" class="outline-2">
<h2 id="org0d6ca9d"><span class="section-number-2">1.</span> THE PROJECT</h2>
<div class="outline-text-2" id="text-1">
<p>
I'm writing a game in Common Lisp and C (using CFFI).
So far I have:
</p>
<ol class="org-ol">
<li>A basic UI with graphics.</li>
<li>Sounds (played asynchronously).</li>
<li>Simple (region-based) memory management to store sounds, bitmaps, sprites etc.</li>
<li>Some supporting Lisp code.</li>
</ol>
</div>
</div>

<div id="outline-container-orgb6596c7" class="outline-2">
<h2 id="orgb6596c7"><span class="section-number-2">2.</span> MODULE (OR PACKAGE) DEPENDENCIES.</h2>
<div class="outline-text-2" id="text-2">

<figure id="org25f8fee">
<img src="modules.jpg" alt="modules.jpg">

<figcaption><span class="figure-number">Figure 1: </span><i>This diagram shows the approximate structure of the program.</i></figcaption>
</figure>
</div>
</div>

<div id="outline-container-orgbefa10b" class="outline-2">
<h2 id="orgbefa10b"><span class="section-number-2">3.</span> SOURCE CODE</h2>
<div class="outline-text-2" id="text-3">
<p>
Github repository forthcoming.
</p>
</div>
</div>
<div class="taglist"></div>
<h3>END</h3>

<hr>

]]></description>
  <link>./2024-07-28-first-blog-post.html</link>
  <guid>./2024-07-28-first-blog-post.html</guid>
  <pubDate>Sun, 28 Jul 2024 19:11:00 -0700</pubDate>
</item>
</channel>
</rss>
